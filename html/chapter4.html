<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>ansible_tutorial</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            formatNumber: function (n) { return "2" + '.' + n }
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null
      });

      </script>
      <script type="text/javascript" src="MathJax/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="cid8" data-tralics-id="cid8" class="chapter" data-number="2" data-chapter="chapter4"><h1><a href="chapter4.html#cid8" class="heading hyperref"><span class="number">Chapter 2 </span>Learning to Write Playbooks</a></h1>
<p>In this tutorial we are going to create a simple playbook to add system users, install and start ntp service and some basic utilities.</p>
<div id="uid19" data-tralics-id="uid19" class="subsection" data-number="2.6.1"><h3><a href="chapter4.html#uid19" class="heading hyperref"><span class="number">2.6.1 </span>Creating our first playbook</a></h3>
<ul>
<li>Change working directory to /vagrant/code/chap4
<div class="code"><div class="highlight"><pre>     cd /vagrant/code/chap4
```  
  * Create playbook.yml and add the content below
</pre></div></div>
<p>—</p>
</li>
<li>name: Base Configurations for ALL hosts
hosts: all
become: true
tasks:
<ul>
<li>name: create admin user
user: name=admin state=present uid=5001
</li>
<li>name: remove dojo
user: name=dojo state=absent
</li>
<li>name: install tree
yum: name=tree state=present
</li>
<li>name: install ntp
yum: name=ntp state=present
</li>
<li>name: start ntp service
service: name=ntpd state=started enabled=yes
“‘
</li></ul>
</li></ul>
</div>
<div id="uid27" data-tralics-id="uid27" class="subsection" data-number="2.6.2"><h3><a href="chapter4.html#uid27" class="heading hyperref"><span class="number">2.6.2 </span>Running the playbook</a></h3>
<p>To run the playbook, we are going to execute <strong>ansible-playbook</strong> command.<span class="intersentencespace"></span> Lets first examine the options that this command supports.</p>
<div class="code"><div class="highlight"><pre>ansible-playbook --help
</pre></div></div>
<div class="code"><div class="highlight"><pre>[output]

Usage: ansible-playbook playbook.yml

Options:
  --ask-become-pass     ask for privilege escalation password
  -k, --ask-pass        ask for connection password
  --ask-su-pass         ask for su password (deprecated, use become)
  -K, --ask-sudo-pass   ask for sudo password (deprecated, use become)
  --ask-vault-pass      ask for vault password
  -b, --become          run operations with become (nopasswd implied)
  --become-method=BECOME_METHOD
                        privilege escalation method to use (default=sudo),
                        valid choices: [ sudo | su | pbrun | pfexec | runas |
                        doas ]

.......
</pre></div></div>
<p>To run the playbook, we could call YAML file as an argument.<span class="intersentencespace"></span> Since we have already defined the inventory and configurations, additional options are not necessary at this time.</p>
<div class="code"><div class="highlight"><pre>ansible-playbook playbook.yml
</pre></div></div>
<div class="code"><div class="highlight"><pre>[output]

PLAY [Base Configurations for ALL hosts] ***************************************

TASK [setup] *******************************************************************
ok: [192.168.61.14]
ok: [192.168.61.11]
ok: [localhost]
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [create admin user] *******************************************************
changed: [192.168.61.13]
changed: [192.168.61.12]
changed: [localhost]
changed: [192.168.61.11]
changed: [192.168.61.14]

TASK [remove dojo] *************************************************************
changed: [192.168.61.14]
changed: [localhost]
changed: [192.168.61.12]
changed: [192.168.61.11]
changed: [192.168.61.13]

TASK [install tree] ************************************************************
ok: [localhost]
ok: [192.168.61.13]
ok: [192.168.61.12]
ok: [192.168.61.14]
ok: [192.168.61.11]

TASK [install ntp] *************************************************************
changed: [192.168.61.12]
changed: [192.168.61.13]
changed: [192.168.61.11]
changed: [localhost]
changed: [192.168.61.14]

TASK [start ntp service] *******************************************************
changed: [192.168.61.11]
changed: [localhost]
changed: [192.168.61.13]
changed: [192.168.61.12]
changed: [192.168.61.14]
</pre></div></div>
</div>
<div id="uid28" data-tralics-id="uid28" class="subsection" data-number="2.6.3"><h3><a href="chapter4.html#uid28" class="heading hyperref"><span class="number">2.6.3 </span>Adding second play in the playbook</a></h3>
<p>Lets add a second play specific to app servers.<span class="intersentencespace"></span> Add the following block of code in playbook.yml file and save</p>
<div class="code"><div class="highlight"><pre>- name: App Server Configurations
  hosts: app
  become: true
  tasks:
    - name: create app user
      user: name=app state=present uid=5003

    - name: install git
      yum:  name=git  state=present

```  

Run the playbook again...  
</pre></div></div>
<p>ansible-playbook playbook.yml
</p><div class="code"></div>
<p>PLAY [Base Configurations for ALL hosts] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***</p>
<p>TASK [setup] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [localhost]
ok: [192.168.61.14]
ok: [192.168.61.13]
ok: [192.168.61.12]
ok: [192.168.61.11]</p>
<p>TASK [create admin user] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.14]
ok: [localhost]
ok: [192.168.61.13]
ok: [192.168.61.12]
ok: [192.168.61.11]</p>
<p>TASK [remove dojo] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.14]
ok: [192.168.61.12]
ok: [192.168.61.11]
ok: [localhost]
ok: [192.168.61.13]</p>
<p>TASK [install tree] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>
ok: [192.168.61.11]
ok: [192.168.61.12]
ok: [localhost]
ok: [192.168.61.13]
ok: [192.168.61.14]</p>
<p>TASK [install ntp] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.12]
ok: [192.168.61.13]
ok: [192.168.61.14]
ok: [192.168.61.11]
ok: [localhost]</p>
<p>TASK [start ntp service] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.14]
ok: [localhost]
ok: [192.168.61.11]
ok: [192.168.61.12]</p>
<p>PLAY [App Server Configurations] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*****</p>
<p>TASK [setup] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [create app user] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***
changed: [192.168.61.12]
changed: [192.168.61.13]</p>
<p>TASK [install git] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>PLAY RECAP <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***
192.168.61.11 : ok=6 changed=0 unreachable=0 failed=0
192.168.61.12 : ok=9 changed=1 unreachable=0 failed=0
192.168.61.13 : ok=9 changed=1 unreachable=0 failed=0
192.168.61.14 : ok=6 changed=0 unreachable=0 failed=0
localhost : ok=6 changed=0 unreachable=0 failed=0
</p><div class="code"><div class="highlight"><pre>### Limiting the execution to a particular group  

Now run the following command to restrict the playbook execution to *app servers*  
</pre></div></div>
<p>ansible-playbook playbook.yml –limit app</p>
<div class="code"><div class="highlight"><pre>This will give us the following output, plays will be executed only on app servers...  
</pre></div></div>
<p>PLAY [Base Configurations for ALL hosts] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***</p>
<p>TASK [setup] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [create admin user] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [remove dojo] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.12]
ok: [192.168.61.13]</p>
<p>TASK [install tree] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [install ntp] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.12]
ok: [192.168.61.13]</p>
<p>TASK [start ntp service] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.12]
ok: [192.168.61.13]</p>
<p>PLAY [App Server Configurations] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*****</p>
<p>TASK [setup] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [create app user] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***
ok: [192.168.61.13]
ok: [192.168.61.12]</p>
<p>TASK [install git] <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>*
ok: [192.168.61.12]
ok: [192.168.61.13]</p>
<p>PLAY RECAP <strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>***
192.168.61.12 : ok=9 changed=0 unreachable=0 failed=0
192.168.61.13 : ok=9 changed=0 unreachable=0 failed=0</p>
<div class="code"><div class="highlight"><pre>## Exercise:
Create a Playbook with the following specifications,
  * It should apply only on local host (ansible host)
  * Should use become method
  * Should create a **user** called webadmin with shell as "/bin/sh"
  * Should install and start **nginx** service
  * Should **deploy** a sample html app into the default web root directory of nginx using ansible's **git** module.
    * Source repo:  https://github.com/schoolofdevops/html-sample-app
    * Deploy Path : /usr/share/nginx/html/app
    * The user to deploy the app would be nginx


#####  TODO for Course Creator:
   - Fail the task (w.g. service name = ntp).
   - It will create a retry file
   Use that to feed into to ansible-playbook with --limit option
   e.g.
   ```
    ansible-playbook playbook.yml --limit @/tmp/playbook.rerty
   ```
</pre></div></div>
</div></div>
    </div>
  </body>
</html>
